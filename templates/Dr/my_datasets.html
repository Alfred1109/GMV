{% extends "clinical_base.html" %}

{% block title %}我的数据集 - 医学临床科研专病数据管理平台{% endblock %}

{% block custom_sidebar %}
        <!-- 数据集过滤器 -->
        <div class="clinical-info-box sidebar-box">
            <div class="info-box-title">
                <i class="bi bi-funnel"></i> 数据集过滤器
            </div>
            <div class="info-box-content">
                <form class="dataset-filter-form">
                    <div class="mb-3">
                        <label class="form-label">数据类型</label>
                        <div class="filter-options">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="type-all" checked>
                                <label class="form-check-label" for="type-all">全部类型</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="type-patient">
                                <label class="form-check-label" for="type-patient">患者数据</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="type-clinical">
                                <label class="form-check-label" for="type-clinical">临床数据</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="type-imaging">
                                <label class="form-check-label" for="type-imaging">医学影像</label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">时间范围</label>
                        <select class="form-select form-select-sm">
                            <option value="all">全部时间</option>
                            <option value="last-week">最近一周</option>
                            <option value="last-month">最近一个月</option>
                            <option value="last-year">最近一年</option>
                        </select>
                    </div>
                    <button type="button" class="clinical-button w-100">
                        <i class="bi bi-search"></i> 应用过滤
                    </button>
                </form>
            </div>
        </div>

        <!-- 数据集分布 -->
        <div class="clinical-info-box sidebar-box">
            <div class="info-box-title">
                <i class="bi bi-pie-chart"></i> 数据集分布
            </div>
            <div class="info-box-content">
                {% if datasets and datasets|length > 0 %}
                    <div class="dataset-usage-chart">
                        <canvas id="datasetUsageChart" width="100" height="100"></canvas>
                    </div>
                    <div class="dataset-usage-legend mt-3">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #4a89dc;"></div>
                            <div class="legend-text">患者数据</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #2ecc71;"></div>
                            <div class="legend-text">临床数据</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f39c12;"></div>
                            <div class="legend-text">医学影像</div>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #e74c3c;"></div>
                            <div class="legend-text">其他</div>
                        </div>
                    </div>
                {% else %}
                    <div class="empty-stats-container">
                        <p>暂无数据集统计数据</p>
                    </div>
                {% endif %}
            </div>
        </div>
{% endblock %}

{% block content %}
<!-- 顶部导航栏 -->
<div class="top-navigation">
    <div class="top-nav-left">
        <div class="content-title">
            我的数据集 <i class="bi bi-database info-icon"></i>
        </div>
    </div>
    <div class="top-nav-right">
        <a href="{{ url_for('doctor_dashboard') }}" class="clinical-button secondary">
            <i class="bi bi-arrow-left"></i> 返回工作台
        </a>
        <button class="clinical-button" data-bs-toggle="modal" data-bs-target="#newDatasetModal">
            <i class="bi bi-plus-circle"></i> 新建数据集
        </button>
    </div>
</div>

<!-- 主内容区域 -->
<div class="main-container">
    <!-- 两栏主内容区域 -->
    <div class="dashboard-container">
    <!-- 中间栏：数据集列表 -->
    <div class="dashboard-middle">
        <!-- 数据集列表 -->
        <div class="clinical-info-box dashboard-box">
            <div class="info-box-title">
                <i class="bi bi-database"></i> 我的数据集列表
                <div class="datasets-counter">
                    共 <span>{{ datasets|length }}</span> 个数据集
                </div>
            </div>
            <div class="info-box-content">
                <div class="dataset-search-bar mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" placeholder="搜索数据集...">
                        <button class="clinical-button" type="button" data-bs-toggle="modal" data-bs-target="#newDatasetModal">
                            <i class="bi bi-plus-lg"></i> 新建数据集
                        </button>
                    </div>
                </div>
                
                {% if datasets and datasets|length > 0 %}
                    <div class="dataset-cards-container">
                        {% for dataset in datasets %}
                        <div class="dataset-card" data-dataset-id="{{ dataset.id }}" {% if dataset.custom_fields %}data-custom-fields='{{ dataset.custom_fields|tojson }}'{% endif %}>
                            <div class="dataset-card-header">
                                <h3>{{ dataset.name }}</h3>
                                <span class="dataset-version">v{{ dataset.version }}</span>
                            </div>
                            <div class="dataset-card-body">
                                <p>{{ dataset.description|truncate(100) if dataset.description else '暂无描述' }}</p>
                                <div class="dataset-metadata">
                                    <span><i class="bi bi-calendar3"></i> {{ dataset.created_at.strftime('%Y-%m-%d') }}</span>
                                    <span><i class="bi bi-files"></i> {{ dataset.size if dataset.size else '未知大小' }}</span>
                                </div>
                            </div>
                            <div class="dataset-card-footer">
                                <div class="dataset-actions">
                                    <a href="{{ url_for('doctor_view_dataset', dataset_id=dataset.id) }}" class="clinical-button" title="查看详情">
                                        <i class="bi bi-eye"></i> 查看
                                    </a>
                                    <a href="javascript:void(0)" class="clinical-button dataset-analyze-btn" data-dataset-id="{{ dataset.id }}" title="分析数据集">
                                        <i class="bi bi-graph-up"></i> 分析
                                    </a>
                                    <a href="javascript:void(0)" class="clinical-button dataset-export-btn" data-dataset-id="{{ dataset.id }}" title="导出数据集">
                                        <i class="bi bi-download"></i> 导出
                                    </a>
                                    <a href="javascript:void(0)" class="clinical-button dataset-import-btn" data-dataset-id="{{ dataset.id }}" title="导入数据">
                                        <i class="bi bi-upload"></i> 导入
                                    </a>
                                    <a href="#" class="clinical-button data-entry-btn" data-dataset-id="{{ dataset.id }}" title="录入数据">
                                        <i class="bi bi-input-cursor-text"></i> 填写数据
                                    </a>
                                    <a href="#" class="clinical-button dataset-share-btn" data-dataset-id="{{ dataset.id }}" title="分享数据集">
                                        <i class="bi bi-share"></i>
                                    </a>
                                    <a href="#" class="clinical-button dataset-duplicate-btn" data-dataset-id="{{ dataset.id }}" title="复制数据集">
                                        <i class="bi bi-copy"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-datasets-container">
                        <div class="empty-datasets-icon">
                            <i class="bi bi-database-slash"></i>
                        </div>
                            <div class="empty-datasets-text">您还没有创建任何数据集</div>
                            <button class="clinical-button" data-bs-toggle="modal" data-bs-target="#newDatasetModal">
                                <i class="bi bi-plus-circle"></i> 创建新数据集
                            </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

        <!-- 右侧栏：数据完整度 -->
    <div class="dashboard-right">
            <!-- 数据完整度 -->
        <div class="clinical-info-box dashboard-box">
            <div class="info-box-title">
                    <i class="bi bi-file-earmark-bar-graph"></i> 数据完整度
            </div>
            <div class="info-box-content">
                {% if datasets and datasets|length > 0 %}
                <div class="data-quality-progress">
                    <div class="quality-item">
                        <div class="quality-label">数据完整性</div>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 85%;" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100">85%</div>
                        </div>
                    </div>
                    <div class="quality-item">
                        <div class="quality-label">数据一致性</div>
                        <div class="progress">
                            <div class="progress-bar bg-info" role="progressbar" style="width: 92%;" aria-valuenow="92" aria-valuemin="0" aria-valuemax="100">92%</div>
                        </div>
                    </div>
                    <div class="quality-item">
                        <div class="quality-label">数据准确性</div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" role="progressbar" style="width: 78%;" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100">78%</div>
                        </div>
                    </div>
                    <div class="quality-item">
                        <div class="quality-label">数据时效性</div>
                        <div class="progress">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">60%</div>
                        </div>
                    </div>
                </div>
                <div class="data-quality-note mt-2">
                    <small>* 数据完整度基于系统自动评估，仅供参考</small>
                </div>
                {% else %}
                <p>暂无数据集质量评估信息</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
</div>

<!-- 新建数据集模态框 -->
<div class="modal fade" id="newDatasetModal" tabindex="-1" aria-labelledby="newDatasetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newDatasetModalLabel">新建数据集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newDatasetForm" action="{{ url_for('doctor_create_dataset') }}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="datasetName" class="form-label">数据集名称</label>
                        <input type="text" class="form-control" id="datasetName" name="dataset_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="datasetType" class="form-label">数据集类型</label>
                        <select class="form-select" id="datasetType" name="dataset_type" required>
                            <option value="" selected disabled>选择数据集类型</option>
                            <option value="patient">患者数据</option>
                            <option value="clinical">临床数据</option>
                            <option value="imaging">医学影像</option>
                            <option value="custom">自定义CRF采集</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    <!-- 自定义采集选项的额外字段 -->
                    <div id="customCollectionOptions" class="mb-3 d-none">
                        <label class="form-label">自定义采集配置</label>
                        <div class="card">
                            <div class="card-body">
                                <div class="custom-fields-container">
                                    <div class="custom-field-item mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">定义数据字段</h6>
                                            <button type="button" class="btn btn-sm btn-outline-primary add-field-btn">
                                                <i class="bi bi-plus"></i> 添加字段
                                            </button>
                                        </div>
                                        <div id="customFieldsList">
                                            <div class="custom-field-row mb-2">
                                                <div class="row g-2">
                                                    <div class="col-md-3">
                                                        <input type="text" class="form-control form-control-sm" name="custom_fields[]" placeholder="字段名称" required>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <select class="form-select form-select-sm" name="custom_field_types[]">
                                                            <option value="text">文本</option>
                                                            <option value="number">数字</option>
                                                            <option value="date">日期</option>
                                                            <option value="select">下拉选择</option>
                                                            <option value="boolean">是/否</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <input type="text" class="form-control form-control-sm" name="custom_field_desc[]" placeholder="字段描述">
                                                    </div>
                                                    <div class="col-md-2">
                                                        <button type="button" class="btn btn-sm btn-outline-danger remove-field-btn">
                                                            <i class="bi bi-x"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="field-options mt-1 d-none">
                                                    <input type="text" class="form-control form-control-sm" name="custom_field_options[]" placeholder="选项值，以逗号分隔">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="custom-collection-settings mb-3">
                                        <h6 class="mb-2">采集设置</h6>
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input type="number" class="form-control" id="customCollectionTarget" name="collection_target" placeholder="目标样本量" min="1">
                                                    <label for="customCollectionTarget">目标样本量</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-floating">
                                                    <input type="date" class="form-control" id="customCollectionDeadline" name="collection_deadline" placeholder="截止日期">
                                                    <label for="customCollectionDeadline">截止日期</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="data-quality-rules mb-3">
                                        <h6 class="mb-2">数据质量规则</h6>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="enforceRequired" name="enforce_required" checked>
                                            <label class="form-check-label" for="enforceRequired">
                                                强制填写必填字段
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="enforceValidation" name="enforce_validation" checked>
                                            <label class="form-check-label" for="enforceValidation">
                                                开启字段验证
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="allowDuplicates" name="allow_duplicates">
                                            <label class="form-check-label" for="allowDuplicates">
                                                允许重复数据项
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="datasetDescription" class="form-label">数据集描述</label>
                        <textarea class="form-control" id="datasetDescription" name="dataset_description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">数据来源</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="data_source" id="sourceUpload" value="upload" checked>
                            <label class="form-check-label" for="sourceUpload">上传数据文件</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="data_source" id="sourceImport" value="import">
                            <label class="form-check-label" for="sourceImport">从现有数据导入</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="data_source" id="sourceSelfCollect" value="self_collect">
                            <label class="form-check-label" for="sourceSelfCollect">自行采集数据</label>
                        </div>
                    </div>
                    
                    <!-- 上传文件选项 -->
                    <div id="uploadOptions" class="mb-3">
                        <label for="datasetFile" class="form-label">上传数据文件</label>
                        <input class="form-control" type="file" id="datasetFile" name="dataset_file">
                        <div class="form-text">支持CSV、Excel、SQL备份文件或压缩包。</div>
                    </div>
                    
                    <!-- 导入数据选项 -->
                    <div id="importOptions" class="mb-3 d-none">
                        <label for="importSource" class="form-label">选择导入源</label>
                        <select class="form-select" id="importSource" name="import_source">
                            <option value="" selected disabled>选择数据源</option>
                            <option value="his">医院信息系统(HIS)</option>
                            <option value="pacs">影像存档系统(PACS)</option>
                            <option value="lis">实验室信息系统(LIS)</option>
                            <option value="emr">电子病历(EMR)</option>
                        </select>
                        <div class="form-text">从选定的系统中导入数据需要管理员授权。</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="privacyLevel" class="form-label">隐私级别</label>
                        <select class="form-select" id="privacyLevel" name="privacy_level" required>
                            <option value="private">私有（仅创建者可访问）</option>
                            <option value="team">团队（指定团队成员可访问）</option>
                            <option value="public">公开（所有平台用户可访问）</option>
                        </select>
                    </div>
                    
                    <div id="teamOptions" class="mb-3 d-none">
                        <label for="teamMembers" class="form-label">选择团队成员</label>
                        <select class="form-select" id="teamMembers" name="team_members[]" multiple>
                            <option value="user1">王医生（心内科）</option>
                            <option value="user2">李医生（神经内科）</option>
                            <option value="user3">张教授（心血管研究中心）</option>
                            <option value="user4">刘医生（放射科）</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="clinical-button secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="clinical-button" id="submitNewDataset">创建数据集</button>
            </div>
        </div>
    </div>
</div>

<!-- 导入数据集模态框 -->
<div class="modal fade" id="importDatasetModal" tabindex="-1" aria-labelledby="importDatasetModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importDatasetModalLabel">导入数据</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importForm" enctype="multipart/form-data">
                    <input type="hidden" id="import_dataset_id" name="dataset_id" value="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label class="form-label">导入说明</label>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 您可以通过上传文件批量导入数据。支持CSV、Excel格式，请确保文件的列名与数据集字段名称匹配。
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="importFile" class="form-label">选择文件</label>
                        <input class="form-control" type="file" id="importFile" name="import_file" accept=".csv,.xlsx,.xls">
                        <div class="form-text">支持的格式：CSV、Excel</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">导入选项</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="hasHeader" name="has_header" checked>
                            <label class="form-check-label" for="hasHeader">
                                文件包含表头
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="skipErrors" name="skip_errors" checked>
                            <label class="form-check-label" for="skipErrors">
                                跳过错误行继续导入
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="updateExisting" name="update_existing">
                            <label class="form-check-label" for="updateExisting">
                                更新已存在的记录
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">字段映射</label>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 上传文件后将显示字段映射选项，您可以手动匹配文件列与数据集字段。
                        </div>
                        <div id="fieldMappingContainer" class="d-none">
                            <!-- 添加主键选择 -->
                            <div class="mb-3">
                                <label for="primaryKeyField" class="form-label">主键字段 <span class="text-muted small">(可选，用于更新已有数据)</span></label>
                                <select class="form-select" id="primaryKeyField">
                                    <option value="">-- 不指定主键 --</option>
                                    <!-- 选项将由JavaScript动态填充 -->
                                </select>
                                <div class="form-text">如果指定主键，导入时主键相同的数据将被更新而不是新增</div>
                            </div>
                            
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>文件列名</th>
                                        <th>映射到数据集字段</th>
                                    </tr>
                                </thead>
                                <tbody id="fieldMappingBody">
                                    <!-- 字段映射将在JavaScript中动态填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
                
                <div class="import-progress d-none">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center import-status">准备导入数据...</p>
                </div>
                
                <div class="import-results d-none">
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> <span class="import-success-message"></span>
                    </div>
                    <div class="import-details card">
                        <div class="card-body">
                            <h6>导入详情</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="import-stat">
                                        <div class="import-stat-value" id="totalRowsValue">0</div>
                                        <div class="import-stat-label">总行数</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="import-stat">
                                        <div class="import-stat-value text-success" id="successRowsValue">0</div>
                                        <div class="import-stat-label">成功导入</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="import-stat">
                                        <div class="import-stat-value text-danger" id="errorRowsValue">0</div>
                                        <div class="import-stat-label">导入失败</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3" id="errorDetailsContainer">
                                <h6>错误详情</h6>
                                <div class="error-details-list">
                                    <!-- 错误详情将在JavaScript中动态填充 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="clinical-button secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="clinical-button" id="previewImportBtn">预览</button>
                <button type="button" class="clinical-button success d-none" id="startImportBtn">开始导入</button>
            </div>
        </div>
    </div>
</div>

<!-- 导出数据集模态框 -->
<div class="modal fade" id="exportDatasetModal" tabindex="-1" aria-labelledby="exportDatasetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportDatasetModalLabel">导出数据集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <input type="hidden" id="export_dataset_id" name="dataset_id" value="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <!-- 添加debug信息，帮助排查API问题 -->
                    <div class="debug-info d-none">
                        <div class="alert alert-info small">
                            <p><strong>API信息：</strong></p>
                            <p>导出API路径: /api/datasets/export</p>
                            <p>请求方法: POST</p>
                            <p>内容类型: application/json</p>
                            <p id="debug-csrf-token"></p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">导出格式</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="export_format" id="formatCSV" value="csv" checked>
                                <label class="form-check-label" for="formatCSV">
                                    <i class="bi bi-filetype-csv"></i> CSV 格式
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="export_format" id="formatExcel" value="excel">
                                <label class="form-check-label" for="formatExcel">
                                    <i class="bi bi-file-earmark-excel"></i> Excel 格式
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">导出选项</label>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeHeaders" name="include_headers" checked>
                            <label class="form-check-label" for="includeHeaders">
                                包含列标题
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeMetadata" name="include_metadata" checked>
                            <label class="form-check-label" for="includeMetadata">
                                包含元数据信息
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="includeTimestamp" name="include_timestamp" checked>
                            <label class="form-check-label" for="includeTimestamp">
                                包含时间戳
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3 data-range-section">
                        <label class="form-label">数据范围</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="data_range" id="allData" value="all" checked>
                            <label class="form-check-label" for="allData">
                                导出全部数据
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="data_range" id="filteredData" value="filtered">
                            <label class="form-check-label" for="filteredData">
                                仅导出筛选后的数据
                            </label>
                        </div>
                    </div>
                </form>
                
                <div class="export-progress d-none">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p class="text-center export-status">准备导出数据...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="clinical-button secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="clinical-button" id="startExportBtn">开始导出</button>
            </div>
        </div>
    </div>
</div>

<style>
/* 两栏布局容器 */
.dashboard-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

/* 中间内容区 */
.dashboard-middle {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* 右侧内容区 */
.dashboard-right {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* 数据集卡片容器 */
.dataset-cards-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

/* 数据集卡片样式 */
.dataset-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.dataset-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.dataset-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.dataset-card-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
}

.dataset-version {
    font-size: 0.8rem;
    color: #757575;
    background-color: #f5f5f5;
    padding: 2px 6px;
    border-radius: 12px;
}

.dataset-card-body {
    margin-bottom: 15px;
    flex-grow: 1;
}

.dataset-card-body p {
    margin-bottom: 10px;
    color: #555;
}

.dataset-metadata {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-top: 10px;
    font-size: 0.85rem;
    color: #757575;
}

.dataset-card-footer {
    border-top: 1px solid #f0f0f0;
    padding-top: 12px;
}

.dataset-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

/* 数据集分布图表样式 */
.dataset-usage-chart {
    width: 100%;
    height: 200px;
    margin-bottom: 15px;
}

.dataset-usage-legend {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
}

.legend-text {
    font-size: 0.9rem;
    color: #555;
}

/* 空数据集容器 */
.empty-datasets-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
    text-align: center;
}

.empty-datasets-icon {
    font-size: 3rem;
    color: #bdbdbd;
    margin-bottom: 15px;
}

.empty-datasets-text {
    color: #757575;
    margin-bottom: 20px;
    font-size: 1.1rem;
}

/* 数据质量进度条样式 */
.data-quality-progress {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.quality-item {
    margin-bottom: 10px;
}

.quality-label {
    margin-bottom: 5px;
    font-size: 0.9rem;
    color: #555;
    font-weight: 500;
}

.progress {
    height: 20px;
    border-radius: 10px;
    background-color: #f5f5f5;
    overflow: hidden;
}

.data-quality-note {
    color: #757575;
    font-size: 0.85rem;
}

/* 数据集计数器 */
.datasets-counter {
    font-size: 0.9rem;
    color: #757575;
}

.datasets-counter span {
    font-weight: 600;
    color: #333;
}

/* 响应式布局 */
@media (max-width: 1200px) {
    .dashboard-container {
        grid-template-columns: 3fr 2fr;
    }
}

@media (max-width: 992px) {
    .dashboard-container {
        grid-template-columns: 1fr;
    }
    
    .dataset-cards-container {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .dataset-cards-container {
        grid-template-columns: 1fr;
    }
}
</style>

{% endblock %}