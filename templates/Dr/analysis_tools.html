{% extends "clinical_base.html" %}

{% block title %}分析工具 - 医学临床科研专病数据管理平台{% endblock %}

{% block extra_css %}
<style>
/* 分析工具页面特定样式 */
.analysis-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

/* 工具内容区 */
.tool-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* 结果预览区 */
.result-area {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* 工具面板 */
.tool-panel {
    display: none;
}

.tool-panel.active {
    display: block;
}

/* 工具项目样式 */
.tool-item {
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tool-item:hover {
    background-color: #f0f7ff;
}

.tool-item.active {
    background-color: #e3f2fd;
    color: #0d6efd;
    font-weight: 500;
}

/* 表单和表单控件样式 */
.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.dataset-select-options {
    margin-bottom: 10px;
}

.variables-container {
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
}

.variable-category {
    font-weight: 500;
    margin: 5px 0;
}

.variable-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
}

.option-selectors {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

/* 结果预览区样式 */
.result-preview {
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.result-placeholder {
    text-align: center;
    color: #aaa;
}

.result-placeholder i {
    font-size: 40px;
    margin-bottom: 10px;
    display: block;
}

/* 导出选项样式 */
.export-format-options,
.export-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 5px;
}

/* 响应式布局 */
@media (max-width: 1200px) {
    .analysis-container {
        grid-template-columns: 3fr 2fr;
    }
}

@media (max-width: 992px) {
    .analysis-container {
        grid-template-columns: 1fr;
    }
    
    .result-area {
        margin-top: 20px;
    }
}

/* 修复顶部导航样式 */
.top-navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    padding: 10px 15px;
}

.top-nav-left {
    display: flex;
    align-items: center;
}

.top-nav-right {
    display: flex;
    gap: 10px;
}

/* 确保内容区域样式 */
.tool-description p {
    margin-bottom: 15px;
    line-height: 1.5;
}

.coming-soon {
    text-align: center;
    padding: 30px 0;
    color: #888;
}

.coming-soon i {
    font-size: 40px;
    margin-bottom: 10px;
    display: block;
}
</style>
{% endblock %}

{% block custom_sidebar %}
<!-- 工具列表 -->
<div class="clinical-info-box sidebar-box">
                <div class="info-box-title">
                    <i class="bi bi-tools"></i> 分析工具集
                </div>
                <div class="info-box-content">
                    <div class="tools-list">
                        <div class="tool-category">
                            <div class="category-header">
                                <i class="bi bi-graph-up"></i> 统计分析
                            </div>
                            <div class="tool-item active" data-tool="descriptive">
                                <i class="bi bi-clipboard-data"></i> 描述性统计
                            </div>
                            <div class="tool-item" data-tool="hypothesis">
                                <i class="bi bi-123"></i> 假设检验
                            </div>
                            <div class="tool-item" data-tool="correlation">
                                <i class="bi bi-arrow-down-up"></i> 相关性分析
                            </div>
                            <div class="tool-item" data-tool="regression">
                                <i class="bi bi-graph-up-arrow"></i> 回归分析
                            </div>
                        </div>
                        
                        <div class="tool-category">
                            <div class="category-header">
                                <i class="bi bi-file-medical"></i> 临床分析
                            </div>
                            <div class="tool-item" data-tool="survival">
                                <i class="bi bi-activity"></i> 生存分析
                            </div>
                            <div class="tool-item" data-tool="risk">
                                <i class="bi bi-shield-check"></i> 风险评估
                            </div>
                            <div class="tool-item" data-tool="outcome">
                                <i class="bi bi-clipboard-check"></i> 结局预测
                            </div>
                        </div>
                        
                        <div class="tool-category">
                            <div class="category-header">
                                <i class="bi bi-pie-chart"></i> 可视化
                            </div>
                            <div class="tool-item" data-tool="charts">
                                <i class="bi bi-bar-chart"></i> 图表生成
                            </div>
                            <div class="tool-item" data-tool="reports">
                                <i class="bi bi-file-earmark-text"></i> 自动报告
                            </div>
                        </div>
                    </div>
                </div>
</div>
{% endblock %}

{% block content %}
<!-- 顶部导航栏 -->
<div class="top-navigation">
    <div class="top-nav-left">
        <div class="content-title">
            分析工具 <i class="bi bi-bar-chart-line"></i>
        </div>
    </div>
    <div class="top-nav-right">
        <a href="javascript:void(0)" class="clinical-button secondary" onclick="openExportModal()">
            <i class="bi bi-download"></i> 导出数据
        </a>
            </div>
        </div>

<!-- 主内容区域容器 -->
<div class="analysis-container">
    <!-- 左侧：工具内容区 -->
    <div class="tool-content">
            <!-- 描述性统计工具 -->
            <div class="tool-panel active" id="descriptive-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-clipboard-data"></i> 描述性统计
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>描述性统计工具可帮助您计算并可视化数据集中变量的基本统计信息，包括均值、中位数、标准差、四分位数等。</p>
                        </div>
                        
                        <form class="analysis-form">
                            <div class="form-group">
                                <label for="dataset-select">选择数据集</label>
                                <div class="dataset-select-options">
                                    <label class="select-all-option"><input type="checkbox" id="select-all-datasets"> 选择全部可访问的数据集</label>
                                <select class="form-control" id="dataset-select" required>
                                    <option value="">-- 请选择数据集 --</option>
                                    {% for dataset in available_datasets %}
                                    <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                    {% endfor %}
                                </select>
                                    <div class="dataset-selection-status" id="dataset-selection-status" style="display: none;">
                                        已选择全部 <span class="dataset-count">0</span> 个可访问的数据集
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>选择变量</label>
                                <div class="variables-container">
                                    <div class="variables-list">
                                        <div class="variable-category">连续变量</div>
                                        <div class="variable-selector">
                                            <label><input type="checkbox" name="variables" value="age"> 年龄</label>
                                            <label><input type="checkbox" name="variables" value="bmi"> BMI</label>
                                            <label><input type="checkbox" name="variables" value="glucose"> 血糖</label>
                                            <label><input type="checkbox" name="variables" value="bp"> 血压</label>
                                        </div>
                                        
                                        <div class="variable-category">分类变量</div>
                                        <div class="variable-selector">
                                            <label><input type="checkbox" name="variables" value="gender"> 性别</label>
                                            <label><input type="checkbox" name="variables" value="smoking"> 吸烟史</label>
                                            <label><input type="checkbox" name="variables" value="diabetes"> 糖尿病</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>统计选项</label>
                                <div class="option-selectors">
                                    <label><input type="checkbox" name="stats" value="mean" checked> 均值</label>
                                    <label><input type="checkbox" name="stats" value="median" checked> 中位数</label>
                                    <label><input type="checkbox" name="stats" value="sd" checked> 标准差</label>
                                    <label><input type="checkbox" name="stats" value="min" checked> 最小值</label>
                                    <label><input type="checkbox" name="stats" value="max" checked> 最大值</label>
                                    <label><input type="checkbox" name="stats" value="q1"> 第一四分位数</label>
                                    <label><input type="checkbox" name="stats" value="q3"> 第三四分位数</label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">生成统计结果</button>
                                <button type="button" class="clinical-button secondary">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 假设检验工具面板 -->
            <div class="tool-panel" id="hypothesis-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-123"></i> 假设检验
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>假设检验工具可帮助您进行各种统计检验，包括t检验、卡方检验、方差分析等。</p>
                        </div>
                        
                        <form class="analysis-form" id="hypothesisForm">
                            <div class="form-group">
                                <label for="dataset-select-hypothesis">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-hypothesis" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                        </div>
                    </div>
                            
                            <div class="form-group">
                                <label>检验类型</label>
                                <select class="form-select" name="test_type" id="test-type">
                                    <option value="ttest">t检验 (两组均值比较)</option>
                                    <option value="paired_ttest">配对t检验</option>
                                    <option value="anova">方差分析 (ANOVA, 多组均值比较)</option>
                                    <option value="chi2">卡方检验 (分类变量关联)</option>
                                    <option value="fisher">Fisher精确检验 (小样本分类变量)</option>
                                    <option value="wilcoxon">Wilcoxon秩和检验 (非参数检验)</option>
                                    <option value="kruskal">Kruskal-Wallis检验 (非参数多组比较)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>选择变量</label>
                                <div class="variables-container">
                                    <div class="variable-category">连续变量</div>
                                    <div class="variable-selector">
                                        <label><input type="checkbox" name="hypothesis_variables" value="age"> 年龄</label>
                                        <label><input type="checkbox" name="hypothesis_variables" value="bmi"> BMI</label>
                                        <label><input type="checkbox" name="hypothesis_variables" value="glucose"> 血糖</label>
                                        <label><input type="checkbox" name="hypothesis_variables" value="bp"> 血压</label>
                                    </div>
                                    
                                    <div class="variable-category">分类变量</div>
                                    <div class="variable-selector">
                                        <label><input type="checkbox" name="hypothesis_variables" value="gender"> 性别</label>
                                        <label><input type="checkbox" name="hypothesis_variables" value="smoking"> 吸烟史</label>
                                        <label><input type="checkbox" name="hypothesis_variables" value="diabetes"> 糖尿病</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" id="group-variable-container">
                                <label>分组变量</label>
                                <select class="form-select" name="group_variable" id="group-variable">
                                    <option value="">-- 请选择分组变量 --</option>
                                    <option value="gender">性别</option>
                                    <option value="smoking">吸烟史</option>
                                    <option value="diabetes">糖尿病</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>显著性水平 (α)</label>
                                <select class="form-select" name="alpha">
                                    <option value="0.05" selected>0.05 (5%)</option>
                                    <option value="0.01">0.01 (1%)</option>
                                    <option value="0.1">0.1 (10%)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>假设类型</label>
                                <div class="option-selectors">
                                    <label><input type="radio" name="hypothesis" value="two-sided" checked> 双侧检验</label>
                                    <label><input type="radio" name="hypothesis" value="greater"> 单侧检验 (大于)</label>
                                    <label><input type="radio" name="hypothesis" value="less"> 单侧检验 (小于)</label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">执行检验</button>
                                <button type="button" class="clinical-button secondary" id="resetHypothesisBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 相关性分析工具面板 -->
            <div class="tool-panel" id="correlation-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-arrow-down-up"></i> 相关性分析
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>相关性分析工具可帮助您分析变量之间的相关关系，包括Pearson相关系数、Spearman相关系数等。</p>
                        </div>
                        
                        <form class="analysis-form" id="correlationForm">
                            <div class="form-group">
                                <label for="dataset-select-correlation">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-correlation" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>相关系数类型</label>
                                <select class="form-select" name="correlation_type">
                                    <option value="pearson" selected>Pearson相关系数 (线性关系)</option>
                                    <option value="spearman">Spearman相关系数 (等级相关)</option>
                                    <option value="kendall">Kendall's Tau (非参数相关)</option>
                                    <option value="point_biserial">点二列相关 (连续变量与二分变量)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>选择变量</label>
                                <div class="variables-container">
                                    <div class="variable-category">连续变量</div>
                                    <div class="variable-selector">
                                        <label><input type="checkbox" name="correlation_variables" value="age"> 年龄</label>
                                        <label><input type="checkbox" name="correlation_variables" value="bmi"> BMI</label>
                                        <label><input type="checkbox" name="correlation_variables" value="glucose"> 血糖</label>
                                        <label><input type="checkbox" name="correlation_variables" value="bp"> 血压</label>
                                    </div>
                                    
                                    <div class="variable-category">分类变量 (用于点二列相关)</div>
                                    <div class="variable-selector">
                                        <label><input type="checkbox" name="correlation_variables" value="gender"> 性别</label>
                                        <label><input type="checkbox" name="correlation_variables" value="smoking"> 吸烟史</label>
                                        <label><input type="checkbox" name="correlation_variables" value="diabetes"> 糖尿病</label>
                                    </div>
                                </div>
                                <small class="form-text text-muted">请至少选择两个变量进行分析</small>
                            </div>
                            
                            <div class="form-group">
                                <label>显著性检验</label>
                                <div class="option-selectors">
                                    <label><input type="checkbox" name="significance_test" value="true" checked> 进行显著性检验</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>可视化选项</label>
                                <div class="option-selectors">
                                    <label><input type="checkbox" name="visualize" value="heatmap" checked> 热力图</label>
                                    <label><input type="checkbox" name="visualize" value="scatter" checked> 散点图矩阵</label>
                                    <label><input type="checkbox" name="visualize" value="network"> 网络图</label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">计算相关性</button>
                                <button type="button" class="clinical-button secondary" id="resetCorrelationBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 回归分析工具面板 -->
            <div class="tool-panel" id="regression-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-graph-up-arrow"></i> 回归分析
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>回归分析工具可帮助您建立各种回归模型，包括线性回归、逻辑回归等。</p>
                        </div>
                        
                        <form class="analysis-form" id="regressionForm">
                            <div class="form-group">
                                <label for="dataset-select-regression">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-regression" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>回归类型</label>
                                <select class="form-select" name="regression_type">
                                    <option value="linear" selected>线性回归</option>
                                    <option value="logistic">逻辑回归</option>
                                    <option value="polynomial">多项式回归</option>
                                    <option value="ridge">岭回归</option>
                                    <option value="lasso">LASSO回归</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>因变量</label>
                                <select class="form-select" name="dependent_variable">
                                    <option value="">-- 请选择因变量 --</option>
                                    <option value="bp">血压</option>
                                    <option value="glucose">血糖</option>
                                    <option value="diabetes">糖尿病</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>自变量</label>
                                <div class="variables-container">
                                    <div class="variable-selector">
                                        <label><input type="checkbox" name="independent_variables" value="age"> 年龄</label>
                                        <label><input type="checkbox" name="independent_variables" value="bmi"> BMI</label>
                                        <label><input type="checkbox" name="independent_variables" value="gender"> 性别</label>
                                        <label><input type="checkbox" name="independent_variables" value="smoking"> 吸烟史</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">建立模型</button>
                                <button type="button" class="clinical-button secondary" id="resetRegressionBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 生存分析工具面板 -->
            <div class="tool-panel" id="survival-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-activity"></i> 生存分析
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>生存分析工具可帮助您分析时间-事件数据，进行Kaplan-Meier分析、Cox比例风险回归等。</p>
                        </div>
                        
                        <form class="analysis-form" id="survivalForm">
                            <div class="form-group">
                                <label for="dataset-select-survival">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-survival" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>分析方法</label>
                                <select class="form-select" name="survival_method">
                                    <option value="kaplan_meier" selected>Kaplan-Meier生存曲线</option>
                                    <option value="cox_regression">Cox比例风险回归</option>
                                    <option value="log_rank">Log-rank检验 (组间比较)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>时间变量</label>
                                <select class="form-select" name="time_variable">
                                    <option value="">-- 请选择时间变量 --</option>
                                    <option value="follow_up_time">随访时间</option>
                                    <option value="survival_months">生存月数</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>事件变量</label>
                                <select class="form-select" name="event_variable">
                                    <option value="">-- 请选择事件变量 --</option>
                                    <option value="death">死亡</option>
                                    <option value="relapse">复发</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">进行分析</button>
                                <button type="button" class="clinical-button secondary" id="resetSurvivalBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 风险评估工具面板 -->
            <div class="tool-panel" id="risk-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-shield-check"></i> 风险评估
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>风险评估工具可帮助您构建和验证风险预测模型，评估患者风险等级。</p>
                        </div>
                        
                        <form class="analysis-form" id="riskForm">
                            <div class="form-group">
                                <label for="dataset-select-risk">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-risk" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>风险模型类型</label>
                                <select class="form-select" name="model_type">
                                    <option value="logistic" selected>Logistic回归</option>
                                    <option value="decision_tree">决策树</option>
                                    <option value="random_forest">随机森林</option>
                                    <option value="xgboost">XGBoost</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>目标变量</label>
                                <select class="form-select" name="target_variable">
                                    <option value="">-- 请选择目标变量 --</option>
                                    <option value="complication">并发症</option>
                                    <option value="readmission">再入院</option>
                                    <option value="mortality">死亡率</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">构建模型</button>
                                <button type="button" class="clinical-button secondary" id="resetRiskBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 结局预测工具面板 -->
            <div class="tool-panel" id="outcome-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-clipboard-check"></i> 结局预测
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>结局预测工具可帮助您预测患者的临床结局，如治愈率、复发率等。</p>
                        </div>
                        
                        <form class="analysis-form" id="outcomeForm">
                            <div class="form-group">
                                <label for="dataset-select-outcome">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-outcome" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>预测结局</label>
                                <select class="form-select" name="outcome_type">
                                    <option value="cure_rate">治愈率</option>
                                    <option value="recurrence">复发率</option>
                                    <option value="readmission">再入院率</option>
                                    <option value="mortality">死亡率</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">进行预测</button>
                                <button type="button" class="clinical-button secondary" id="resetOutcomeBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 图表生成工具面板 -->
            <div class="tool-panel" id="charts-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-bar-chart"></i> 图表生成
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>图表生成工具可帮助您创建各种可视化图表，包括柱状图、折线图、散点图等。</p>
                        </div>
                        
                        <form class="analysis-form" id="chartsForm">
                            <div class="form-group">
                                <label for="dataset-select-charts">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-charts" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>图表类型</label>
                                <select class="form-select" name="chart_type">
                                    <option value="bar" selected>柱状图</option>
                                    <option value="line">折线图</option>
                                    <option value="scatter">散点图</option>
                                    <option value="pie">饼图</option>
                                    <option value="box">箱线图</option>
                                    <option value="heatmap">热力图</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">生成图表</button>
                                <button type="button" class="clinical-button secondary" id="resetChartsBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 自动报告工具面板 -->
            <div class="tool-panel" id="reports-panel">
                <div class="clinical-info-box">
                    <div class="info-box-title">
                        <i class="bi bi-file-earmark-text"></i> 自动报告
                    </div>
                    <div class="info-box-content">
                        <div class="tool-description">
                            <p>自动报告工具可帮助您生成综合性分析报告，包含各种统计分析结果和可视化图表。</p>
                        </div>
                        
                        <form class="analysis-form" id="reportsForm">
                            <div class="form-group">
                                <label for="dataset-select-reports">选择数据集</label>
                                <div class="dataset-select-options">
                                    <select class="form-control" id="dataset-select-reports" required>
                                        <option value="">-- 请选择数据集 --</option>
                                        {% for dataset in available_datasets %}
                                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>报告类型</label>
                                <select class="form-select" name="report_type">
                                    <option value="descriptive" selected>描述性统计报告</option>
                                    <option value="comparative">组间比较报告</option>
                                    <option value="correlation">相关性分析报告</option>
                                    <option value="comprehensive">综合分析报告</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>导出格式</label>
                                <div class="option-selectors">
                                    <label><input type="checkbox" name="export_format" value="docx" checked> Word文档 (.docx)</label>
                                    <label><input type="checkbox" name="export_format" value="pdf"> PDF文档 (.pdf)</label>
                                    <label><input type="checkbox" name="export_format" value="html"> HTML网页 (.html)</label>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="submit" class="clinical-button">生成报告</button>
                                <button type="button" class="clinical-button secondary" id="resetReportsBtn">重置</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 添加其他工具面板 -->
        </div>
    
    <!-- 右侧：结果预览区 -->
    <div class="result-area">
        <div class="clinical-info-box">
            <div class="info-box-title">
                <i class="bi bi-graph-up"></i> 分析结果预览
            </div>
            <div class="info-box-content">
                <div class="result-preview">
                    <div class="result-placeholder">
                        <i class="bi bi-bar-chart-line"></i>
                        <p>统计结果将显示在这里</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 导出模态框 -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">导出数据</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="exportDatasetSelect">选择数据集</label>
                    <div class="dataset-select-options">
                        <label class="select-all-option"><input type="checkbox" id="export-select-all-datasets"> 选择全部可访问的数据集</label>
                    <select class="form-control" id="exportDatasetSelect" required>
                        <option value="">-- 请选择数据集 --</option>
                        {% for dataset in available_datasets %}
                        <option value="{{ dataset.id }}">{{ dataset.name }}</option>
                        {% endfor %}
                    </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>导出格式</label>
                    <div class="export-format-options">
                        <label><input type="radio" name="exportFormat" value="csv" checked> CSV</label>
                        <label><input type="radio" name="exportFormat" value="excel"> Excel</label>
                        <label><input type="radio" name="exportFormat" value="json"> JSON</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>导出选项</label>
                    <div class="export-options">
                        <label><input type="checkbox" name="exportOptions" value="headers" checked> 包含表头</label>
                        <label><input type="checkbox" name="exportOptions" value="metadata"> 包含元数据</label>
                        <label><input type="checkbox" name="exportOptions" value="computed"> 包含计算字段</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="startExportBtn">开始导出</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 添加两个备用的Chart.js CDN链接，增加加载成功率 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 检查Chart.js是否成功加载，如果没有，尝试从备用CDN加载
if (typeof Chart === 'undefined') {
    console.log('主Chart.js CDN加载失败，尝试备用链接...');
    var script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js';
    script.integrity = 'sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==';
    script.crossOrigin = 'anonymous';
    script.referrerPolicy = 'no-referrer';
    document.head.appendChild(script);
    
    // 再次检查并最后尝试使用另一个备用CDN
    script.onerror = function() {
        console.log('备用Chart.js CDN也加载失败，尝试最终备用链接...');
        var script2 = document.createElement('script');
        script2.src = 'https://unpkg.com/chart.js@3.9.1/dist/chart.min.js';
        document.head.appendChild(script2);
    };
}
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // 工具切换
        const toolItems = document.querySelectorAll('.tool-item');
    const toolPanels = document.querySelectorAll('.tool-panel');
        
        toolItems.forEach(item => {
            item.addEventListener('click', function() {
            const toolId = this.getAttribute('data-tool');
                
            // 更新活动工具项
            toolItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                
                // 显示对应的工具面板
            toolPanels.forEach(panel => {
                panel.classList.remove('active');
                if (panel.id === `${toolId}-panel`) {
                    panel.classList.add('active');
                }
            });
        });
    });
    
    // 导出模态框
    window.openExportModal = function() {
        const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
        exportModal.show();
    };
    
    // 全选数据集
    const selectAllDatasets = document.getElementById('select-all-datasets');
    const datasetSelect = document.getElementById('dataset-select');
    const datasetSelectionStatus = document.getElementById('dataset-selection-status');
    
    if (selectAllDatasets && datasetSelect && datasetSelectionStatus) {
        selectAllDatasets.addEventListener('change', function() {
            datasetSelect.disabled = this.checked;
            datasetSelectionStatus.style.display = this.checked ? 'block' : 'none';
                
            if (this.checked) {
                const datasetCount = datasetSelect.options.length - 1; // 减去默认选项
                document.querySelector('.dataset-count').textContent = datasetCount;
            }
        });
    }
        
    // 表单提交处理
    const analysisForm = document.querySelector('.analysis-form');
    if (analysisForm) {
        analysisForm.addEventListener('submit', function(e) {
            e.preventDefault();
                
            // 验证表单
            const selectedDataset = selectAllDatasets.checked || datasetSelect.value;
            const selectedVariables = document.querySelectorAll('input[name="variables"]:checked');
            
            if (!selectedDataset) {
                alert('请选择数据集');
                return;
            }
                
            if (selectedVariables.length === 0) {
                alert('请至少选择一个变量');
                return;
            }
                
            // 模拟生成结果
            generateResults();
        });
    }
    
    // 描述性统计 - 数据集选择变化时加载变量
    if (datasetSelect) {
        datasetSelect.addEventListener('change', function() {
            const datasetId = this.value;
            if (datasetId) {
                loadDatasetVariables(datasetId, 'descriptive');
            }
        });
    }
    
    // 假设检验 - 数据集选择变化时加载变量
    const hypothesisDatasetSelect = document.getElementById('dataset-select-hypothesis');
    if (hypothesisDatasetSelect) {
        hypothesisDatasetSelect.addEventListener('change', function() {
            const datasetId = this.value;
            if (datasetId) {
                loadDatasetVariables(datasetId, 'hypothesis');
            }
        });
    }
    
    // 相关性分析 - 数据集选择变化时加载变量
    const correlationDatasetSelect = document.getElementById('dataset-select-correlation');
    if (correlationDatasetSelect) {
        correlationDatasetSelect.addEventListener('change', function() {
            const datasetId = this.value;
            if (datasetId) {
                loadDatasetVariables(datasetId, 'correlation');
            }
        });
    }
});

// 模拟生成结果
function generateResults() {
    const resultPreview = document.querySelector('.result-preview');
    const selectedDataset = selectAllDatasets.checked ? 'all' : datasetSelect.value;
    const selectedVariables = [];
    
    // 收集选中的变量
    document.querySelectorAll('input[name="variables"]:checked').forEach(input => {
        selectedVariables.push(input.value);
    });
    
    // 收集选中的统计量
    const selectedStats = [];
    document.querySelectorAll('input[name="stats"]:checked').forEach(input => {
        selectedStats.push(input.value);
    });
    
    // 显示加载状态
    resultPreview.innerHTML = `
        <div class="loading-indicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p>正在从数据库获取数据并生成统计结果，请稍候...</p>
        </div>
    `;
                
    // 构建请求参数
    const requestData = {
        dataset_ids: selectedDataset === 'all' ? [] : [parseInt(selectedDataset)],
        variables: selectedVariables,
        stats: selectedStats
    };
    
    // 发送API请求获取实际数据
    fetch('/api/analysis/descriptive', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('获取数据失败: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || '分析失败');
        }
        
        // 生成结果表格HTML
        let tableHTML = `
            <div class="result-content">
                <h4>描述性统计结果</h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                                <th>变量</th>
        `;
        
        // 添加表头 - 统计量
        selectedStats.forEach(stat => {
            tableHTML += `<th>${getStatDisplayName(stat)}</th>`;
        });
        
        tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // 填充表格数据
        if (data.results) {
            let chartLabels = [];
            let chartData = [];
            
            Object.keys(data.results).forEach(varName => {
                const varResult = data.results[varName];
                chartLabels.push(varName);
                
                tableHTML += `<tr><td>${varName}</td>`;
                
                selectedStats.forEach(stat => {
                    const value = varResult.stats && varResult.stats[stat] !== undefined 
                        ? formatStatValue(varResult.stats[stat]) 
                        : 'N/A';
                    tableHTML += `<td>${value}</td>`;
                    
                    // 收集均值数据用于图表
                    if (stat === 'mean') {
                        chartData.push(parseFloat(value) || 0);
                    }
                });
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <div class="result-chart">
                    <canvas id="resultChart" width="400" height="200"></canvas>
                </div>
                <div class="mt-3 text-end">
                    <button class="clinical-button secondary" onclick="exportResults()">
                        <i class="bi bi-download"></i> 导出结果
                    </button>
                </div>
            </div>
            `;
            
            resultPreview.innerHTML = tableHTML;
            
            // 绘制实际数据的图表
            try {
                if (typeof Chart !== 'undefined' && chartLabels.length > 0) {
                    const canvas = document.getElementById('resultChart');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: chartLabels,
                                datasets: [{
                                    label: '均值',
                                    data: chartData,
                                    backgroundColor: chartLabels.map((_, i) => {
                                        const colors = [
                                            'rgba(54, 162, 235, 0.5)',
                                            'rgba(75, 192, 192, 0.5)',
                                            'rgba(255, 159, 64, 0.5)',
                                            'rgba(153, 102, 255, 0.5)',
                                            'rgba(255, 99, 132, 0.5)'
                                        ];
                                        return colors[i % colors.length];
                                    }),
                                    borderColor: chartLabels.map((_, i) => {
                                        const colors = [
                                            'rgba(54, 162, 235, 1)',
                                            'rgba(75, 192, 192, 1)',
                                            'rgba(255, 159, 64, 1)',
                                            'rgba(153, 102, 255, 1)',
                                            'rgba(255, 99, 132, 1)'
                                        ];
                                        return colors[i % colors.length];
                                    }),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: '变量均值比较'
                                    },
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('绘制图表失败:', error);
            }
        } else {
            resultPreview.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 没有找到符合条件的数据
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('分析请求失败:', error);
        resultPreview.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> 分析失败: ${error.message}
            </div>
        `;
    });
}

// 获取统计量的显示名称
function getStatDisplayName(stat) {
    const statNames = {
        'mean': '均值',
        'median': '中位数',
        'sd': '标准差',
        'var': '方差',
        'min': '最小值',
        'max': '最大值',
        'q1': '第一四分位数',
        'q3': '第三四分位数',
        'skewness': '偏度',
        'kurtosis': '峰度'
    };
    return statNames[stat] || stat;
}

// 格式化统计值
function formatStatValue(value) {
    if (value === null || value === undefined) {
        return 'N/A';
    }
    
    if (typeof value === 'number') {
        // 检查是否为整数
        if (Number.isInteger(value)) {
            return value.toString();
        }
        
        // 如果是小数，保留两位小数
        return value.toFixed(2);
    }
    
    return value;
}

// 导出结果
function exportResults() {
    alert('导出功能开发中，即将支持Excel、CSV和PDF格式导出');
}

// 加载数据集变量
function loadDatasetVariables(datasetId, toolType) {
    let variablesContainer;
    
    // 根据工具类型选择不同的变量容器
    switch(toolType) {
        case 'descriptive':
            variablesContainer = document.querySelector('#descriptive-panel .variables-container .variables-list');
            break;
        case 'hypothesis':
            variablesContainer = document.querySelector('#hypothesis-panel .variables-container .variables-list');
            break;
        case 'correlation':
            variablesContainer = document.querySelector('#correlation-panel .variables-container .variables-list');
            break;
        default:
            variablesContainer = document.querySelector('.variables-container .variables-list');
    }
    
    if (!variablesContainer) {
        console.error('找不到变量容器:', toolType);
        return;
    }
    
    // 显示加载状态
    variablesContainer.innerHTML = `
        <div class="loading-indicator">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <span class="ms-2">正在加载变量...</span>
        </div>
    `;
    
    // 调用API获取变量
    fetch(`/api/datasets/${datasetId}/variables`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('获取变量失败: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || '获取变量失败');
        }
        
        // 处理变量数据
        const variables = data.variables || [];
        let continuousVars = [];
        let categoricalVars = [];
        
        // 分类变量
        variables.forEach(variable => {
            if (variable.type === 'continuous' || variable.type === 'number' || variable.type === 'float' || variable.type === 'integer') {
                continuousVars.push(variable);
            } else {
                categoricalVars.push(variable);
            }
        });
        
        // 构建变量选择器HTML
        let variablesHTML = '';
        
        if (continuousVars.length > 0) {
            variablesHTML += `<div class="variable-category">连续变量</div>
                             <div class="variable-selector">`;
            
            continuousVars.forEach(variable => {
                const checkboxName = toolType === 'hypothesis' ? 'hypothesis_variables' : 
                                    toolType === 'correlation' ? 'correlation_variables' : 'variables';
                variablesHTML += `<label><input type="checkbox" name="${checkboxName}" value="${variable.id}"> ${variable.name}</label>`;
            });
            
            variablesHTML += `</div>`;
        }
        
        if (categoricalVars.length > 0) {
            variablesHTML += `<div class="variable-category">分类变量</div>
                             <div class="variable-selector">`;
            
            categoricalVars.forEach(variable => {
                const checkboxName = toolType === 'hypothesis' ? 'hypothesis_variables' : 
                                    toolType === 'correlation' ? 'correlation_variables' : 'variables';
                variablesHTML += `<label><input type="checkbox" name="${checkboxName}" value="${variable.id}"> ${variable.name}</label>`;
            });
            
            variablesHTML += `</div>`;
        }
        
        // 如果没有变量
        if (variables.length === 0) {
            variablesHTML = `<div class="alert alert-info">该数据集没有可用的变量</div>`;
        }
        
        // 更新变量容器
        variablesContainer.innerHTML = variablesHTML;
        
        // 如果是假设检验，还需要更新分组变量下拉列表
        if (toolType === 'hypothesis') {
            const groupVarSelect = document.getElementById('group-variable');
            if (groupVarSelect) {
                // 清除现有选项
                while (groupVarSelect.options.length > 1) {
                    groupVarSelect.remove(1);
                }
                
                // 添加分类变量作为分组变量选项
                categoricalVars.forEach(variable => {
                    const option = document.createElement('option');
                    option.value = variable.id;
                    option.textContent = variable.name;
                    groupVarSelect.appendChild(option);
                });
            }
        }
    })
    .catch(error => {
        console.error('加载变量失败，使用模拟数据:', error);
        
        // 使用模拟数据
        let mockVariables;
        
        // 根据工具类型使用不同的模拟数据
        if (toolType === 'descriptive') {
            mockVariables = [
                { id: 'age', name: '年龄', type: 'continuous' },
                { id: 'bmi', name: 'BMI', type: 'continuous' },
                { id: 'glucose', name: '血糖', type: 'continuous' },
                { id: 'bp', name: '血压', type: 'continuous' },
                { id: 'gender', name: '性别', type: 'categorical' },
                { id: 'smoking', name: '吸烟史', type: 'categorical' },
                { id: 'diabetes', name: '糖尿病', type: 'categorical' }
            ];
        } else if (toolType === 'hypothesis') {
            mockVariables = [
                { id: 'age', name: '年龄', type: 'continuous' },
                { id: 'bmi', name: 'BMI', type: 'continuous' },
                { id: 'glucose', name: '血糖', type: 'continuous' },
                { id: 'bp', name: '血压', type: 'continuous' },
                { id: 'gender', name: '性别', type: 'categorical' },
                { id: 'smoking', name: '吸烟史', type: 'categorical' },
                { id: 'diabetes', name: '糖尿病', type: 'categorical' },
                { id: 'treatment', name: '治疗方案', type: 'categorical' }
            ];
        } else if (toolType === 'correlation') {
            mockVariables = [
                { id: 'age', name: '年龄', type: 'continuous' },
                { id: 'bmi', name: 'BMI', type: 'continuous' },
                { id: 'glucose', name: '血糖', type: 'continuous' },
                { id: 'bp', name: '血压', type: 'continuous' },
                { id: 'cholesterol', name: '胆固醇', type: 'continuous' },
                { id: 'hdl', name: 'HDL', type: 'continuous' },
                { id: 'ldl', name: 'LDL', type: 'continuous' },
                { id: 'gender', name: '性别', type: 'categorical' }
            ];
        } else {
            mockVariables = [
                { id: 'age', name: '年龄', type: 'continuous' },
                { id: 'bmi', name: 'BMI', type: 'continuous' },
                { id: 'gender', name: '性别', type: 'categorical' }
            ];
        }
        
        // 分类变量
        let continuousVars = mockVariables.filter(v => v.type === 'continuous');
        let categoricalVars = mockVariables.filter(v => v.type === 'categorical');
        
        // 构建变量选择器HTML
        let variablesHTML = '';
        
        if (continuousVars.length > 0) {
            variablesHTML += `<div class="variable-category">连续变量</div>
                             <div class="variable-selector">`;
            
            continuousVars.forEach(variable => {
                const checkboxName = toolType === 'hypothesis' ? 'hypothesis_variables' : 
                                    toolType === 'correlation' ? 'correlation_variables' : 'variables';
                variablesHTML += `<label><input type="checkbox" name="${checkboxName}" value="${variable.id}"> ${variable.name}</label>`;
            });
            
            variablesHTML += `</div>`;
        }
        
        if (categoricalVars.length > 0) {
            variablesHTML += `<div class="variable-category">分类变量</div>
                             <div class="variable-selector">`;
            
            categoricalVars.forEach(variable => {
                const checkboxName = toolType === 'hypothesis' ? 'hypothesis_variables' : 
                                    toolType === 'correlation' ? 'correlation_variables' : 'variables';
                variablesHTML += `<label><input type="checkbox" name="${checkboxName}" value="${variable.id}"> ${variable.name}</label>`;
            });
            
            variablesHTML += `</div>`;
        }
        
        // 更新变量容器
        variablesContainer.innerHTML = variablesHTML;
        
        // 如果是假设检验，还需要更新分组变量下拉列表
        if (toolType === 'hypothesis') {
            const groupVarSelect = document.getElementById('group-variable');
            if (groupVarSelect) {
                // 清除现有选项
                while (groupVarSelect.options.length > 1) {
                    groupVarSelect.remove(1);
                }
                
                // 添加分类变量作为分组变量选项
                categoricalVars.forEach(variable => {
                    const option = document.createElement('option');
                    option.value = variable.id;
                    option.textContent = variable.name;
                    groupVarSelect.appendChild(option);
                });
            }
        }
    });
}
</script>
{% endblock %}
    
{% endblock %} 